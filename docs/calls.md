# Руководство по звонкам

Документ описывает сценарии работы звонков, взаимодействие с WCS/FF и обмен сообщениями через веб-сокет и REST API.

## Создание комнаты и начало звонка
1. Клиент инициирует сессию FF через `RoomApi.connect`, передавая URL веб-сервера FF (текущий: `wss://stage.naukotheka.ru:8443`).
2. После успешного подключения вызывается `join` с именем комнаты, которым служит `dialogId` чата.
3. При инициализации комнаты бэкенд отправляет широковещательное сообщение с `cType` **2** (аудио) или **3** (видео) о начале звонка. Поля `owner` содержат id инициатора, `dialog` — id диалога.
4. Ответивший на входящий звонок повторяет шаги 1–2, используя `dialogId` из сообщения о входящем звонке как `roomName`.
5. Если никто не ответил в течение таймаута (30 секунд), звонок завершается.

### Завершение
- **1 на 1**: отправляется сообщение с `cType = 6`.
- **Конференция**: администратор рассылает сообщение `cType = 6002` с массивом `users`, куда помещаются id недозвонившихся в таймаут участников.

```json
{
  "cType": 6002,
  "selectedChatId": 694,
  "users": ["userId_1", "userId_2"]
}
```

- **Отказ от входящего звонка**: пользователь отправляет сообщение `cType = 6001`.

## Управление участниками

### Чтение состояния активного звонка
`GET /calls/dialog/:dialogId/participants`

Ответ содержит статус `status`, роли `roles`, разрешения `permits` и список сессий FF `states` (по одной на текущую реализацию). Пользователи видят только свои пермиты, администраторы — все.

### Статусы участников
Изменяются автоматически при событиях FF или вручную администраторами.

- Изменение статуса: `PATCH /calls/dialog/:dialogId/status`
- Пример уведомления:

```json
{
  "dialog": 1234,
  "cType": 2008,
  "statusUpdates": [
    { "status": 5, "users": ["...", "..."] },
    { "status": 4, "users": ["..."] }
  ]
}
```

Доступные статусы (#190):

| Код | Описание |
| --- | --- |
| 1 | Приглашен |
| 2 | Участвовал в звонке (конечный) |
| 3 | Отклонил звонок (конечный) |
| 4 | Пропустил вызов (начало звонка) |
| 5 | Участвует в звонке |
| 6 | Ожидает в лобби |
| 7 | Удален из звонка (конечный) |
| 8 | Пропустил звонок (конечный) |

### Типичные переходы
- Приглашен → Участвует → Участвовал
- Приглашен → Отклонил
- Приглашен → Пропустил вызов → В лобби → Участвует → Участвовал
- Приглашен → Участвует → Исключен

### Автоматическая установка статусов
- Первая сессия FF от организатора: статус **Приглашен (1)** для всех участников чата.
- Вторая сессия FF от ответившего: статус **Участвует (5)** для организатора и ответившего.
- Последующие сессии FF: статус **Участвует (5)** для новых участников.
- Истечение 30 секунд с начала звонка: присоединяющийся участник переводится в **В лобби (6)**, а текущая сессия FF останавливается.
- Истечение 30 секунд после выхода всех администраторов: статус **Участвовал (2)** для участвовавших, **Пропустил звонок (8)** для пропустивших.

### Ручная установка статусов администраторами
- Пользователь в лобби (6) → пригласить в звонок: установить статус **Участвует (5)** через REST.
- Пользователь участвует (5) → исключить: установить статус **Исключен (7)** через REST.

## Роли и разрешения

### Роли

| Роль | uref | Пермиты |
| --- | --- | --- |
| Организатор звонка | 37:301 | 601–612 |
| Администратор звонка | 37:302 | 601–609, 611 |
| Пользователь чата | 37:303 | 602–609 |

### Разрешения

| Права | uref |
| --- | --- |
| Начать звонок | 82:600 |
| Завершить звонок | 82:601 |
| Камера | 82:602 |
| Микрофон | 82:603 |
| Поднять руку | 82:604 |
| Шаринг экрана | 82:605 |
| Присоединяться к звонку | 82:606 |
| Участвовать в звонке | 82:607 |
| Записывать звонок | 82:608 |
| Смотреть записи | 82:609 |
| Назначать администраторов | 82:610 |
| Управлять участниками | 82:611 |
| Признак организатора | 82:612 |

### Управление ролями и доступами
`PATCH /calls/dialog/:dialogId/permits`

```json
{
  "user": "user-id",
  "role": "37:302",
  "addPermits": ["82:605"],
  "delPermits": ["82:608"]
}
```

Сообщение об изменении доступа (`cType = 2007`) отправляется админам и пользователю; остальным — только роль при ее изменении.

## Состояния сессий FF

### Обновление состояния
`PATCH /calls/dialog/:dialogId/state` (доступно владельцу сессии или администратору с правом 82:611).

```json
{
  "user": "user-id",
  "mediaSessionId": "session-id",
  "state": {
    "micOn": true,
    "camOn": false,
    "handUp": false,
    "sharingScreen": false
  }
}
```

Сообщение `cType = 2006` рассылается всем участникам с обновленным состоянием.

## Use Case: управление состояниями, статусами и ролями

1. **Начало звонка**
   - REST: `GET /dialogs/info/:dialogId` для заполнения аватаров.
   - WCS: инициировать медиапоток и создать комнату.
   - WS: ожидать сообщение о начале звонка (`cType` 2 или 3) с добавленным `callId`.
   - Бэк: добавляет участников, присваивает инициатору роль 37:301, остальным — 37:303.
   - WS: ждать сообщение об активном звонке 2001 или завершении 6 через 30 секунд.
   - REST: при ответе на звонок запросить `GET /calls/dialog/:dialogId/participants`, отрисовать активных участников.

2. **Ответ первого участника**
   - WCS: инициировать медиапоток и создать комнату.
   - После успешного создания ожидать сообщение 2001.
   - WS: получение 2001 означает успешное подключение и смену статуса звонка на «Активен».
   - REST: запросить сведения о звонке и участниках.

3. **Подключение второго и последующих участников**
   - WS: есть сообщение 2001 или флаг `activeCall` в чате, и нет сообщения 6003.
   - WCS: инициировать медиапоток и создать комнату.
   - WS: ожидать сообщение 2008 о смене собственного статуса на **Участвует (5)**.
   - REST: запросить сведения о звонке и участниках.

3.1. **Попытка подключения без обработки 6003**
   - WCS: инициировать медиапоток и создать комнату.
   - Бэк определяет, что статус участника **Приглашен (1)**, но таймаут истек, завершает начатую сессию WCS и ставит статус **В лобби (6)**.
   - WS: отправляется 2008 с новым статусом.
   - REST: запросить сведения и ждать приглашения 2004.

4. **Подключение после таймаута**
   - WS: получено 6003 о пропущенном начале.
   - WS: отправить запрос 2002 и ждать ответа; статус меняется на **В лобби (6)**.

4.0. **Разрешение администратора**
   - Администратор отправляет 2003:

```json
{
  "cType": 2003,
  "dialog": 1234,
  "users": ["user-id"],
  "text": null
}
```

   - Бэк добавляет отсутствующих участников или меняет статус с **В лобби (6)** на **Приглашен (1)** и шлет приглашение 2004.

4.1. **Получено разрешение на участие**
   - WS: получить 2004.
   - WCS: инициировать медиапоток и создать комнату.
   - REST: запросить участников/роли/пермиты/состояния и отобразить их.

4.2. **Нет разрешения**
   - WS: получено изменение статуса на **В лобби (6)**; отрисовать текущих участников и ждать 2004.

5. **Изменение своего состояния**
   - REST: `PATCH /calls/dialog/:dialogId/state` с новой конфигурацией (micOn, camOn и т.д.). При запрете вернется 403.
   - Клиент: обновить свое состояние.
   - WS: все участники получают сообщение 2006.

6. **Выход из звонка**
   - **Правильный способ**: `Room.leave()`.
     - Бэк завершает все сессии пользователя, ставит статус **Участвовал (2)** и выполняет постобработку администраторов/зависших звонков.
   - **Допустимый способ**: `Room.unpublish()`.
     - Бэк очищает данные о сессии; если сессий больше нет, ставит **Участвовал (2)** и выполняет постобработку.

7. **Завершение звонка**
   - REST: `POST /calls/:id/stop` (администратор/организатор или любой участник звонка 1×1).
   - Бэк завершает WCS-сессии, меняет статусы (**Участвовал (2)** или **Пропустил звонок (8)**), рассылает:
     - всем: `cType = 6` (CALL_ENDED);
     - пропустившим: `cType = 6004` (CALL_END_MISSED);
     - останавливает запись, если была.

### Постобработка звонка
- Если администраторских сессий больше нет, звонок считается зависшим и будет остановлен через 30 секунд.
- При выходе организатора система пытается назначить организатором первого из текущих администраторов; если не удается — звонок завершается как зависший.

## Типы сообщений (cType)

| Код | Константа | Описание |
| --- | --- | --- |
| 1 | TEXT_MESSAGE | Текстовое сообщение |
| 2 | AUDIO_CALL_STARTED | Начало аудио-звонка |
| 2001 | CALL_ACTIVATED | Звонок стал активным |
| 2002 | JOIN_CALL | Запрос на присоединение |
| 2003 | LET_JOIN_CALL | Разрешение на присоединение |
| 2004 | CALL_USERS | Вызов пользователей |
| 2005 | CALL_PARTICIPATE | Разрешение на участие |
| 2006 | CALL_USER_STATE_SET | Обновление состояния пользователя |
| 2007 | CALL_USER_PERMITS_SET | Обновление разрешений пользователя |
| 2008 | CALL_USER_STATUS_SET | Обновление статуса участника |
| 3 | VIDEO_CALL_STARTED | Начало видео-звонка |
| 4 | VOICE_MESSAGE | Голосовое сообщение |
| 5 | SYSTEM_MESSAGE | Системное сообщение |
| 6 | CALL_ENDED | Завершение звонка |
| 6001 | CALL_DECLINED | Отклонение входящего звонка |
| 6002 | CALL_KICKED | Исключение пользователя |
| 6003 | CALL_START_MISSED | Пропуск начала звонка |
| 6004 | CALL_END_MISSED | Пропуск окончания звонка |
